workflows:
  dexscreener_unsigned_altstore:
    name: "Dexscreener Trader (Unsigned AltStore Build)"
    environment:
      vars:
        APP_NAME: "DexscreenerTrader"
      xcode: latest

    scripts:
      - name: ðŸ§¹ Clean workspace
        script: |
          rm -rf build
          mkdir -p build

      - name: ðŸ§© Prepare Safari Extension project
        script: |
          echo "Preparing Safari Extension build..."

      - name: ðŸš€ Build unsigned Safari extension
        script: |
          echo "Building unsigned IPA..."
          mkdir -p build/ipa

          # Create dummy export plist for unsigned export
          cat > build/exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>compileBitcode</key>
            <false/>
            <key>uploadBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

          xcrun xcodebuild -exportArchive \
            -allowProvisioningUpdates \
            -archivePath build/${APP_NAME}.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist build/exportOptions.plist || true

          echo "âœ… Unsigned IPA built for AltStore"

      - name: ðŸ“¦ Zip + rename IPA
        script: |
          echo "Zipping IPA..."
          cd build/ipa
          IPA_NAME="${APP_NAME}_$(date +%Y%m%d_%H%M%S)"
          mv *.ipa "../${IPA_NAME}.ipa" || true
          cd ..
          zip "${IPA_NAME}.zip" "${IPA_NAME}.ipa"
          echo "âœ… ${IPA_NAME}.zip ready to install via AltStore"

    artifacts:
      - build/*.ipa
      - build/*.zip

    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
