workflows:
  dexscreener_safari_ios:
    name: Dexscreener Safari iOS
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      vars:
        APP_NAME: "DexscreenerTrader"
        BUNDLE_ID: "com.millitradez.dexscreenertrader"
        CM_API_TOKEN: "YOUR_API_TOKEN_HERE"
      xcode: latest
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true
    scripts:
      - name: ğŸ”§ Prepare Safari Extension project
        script: |
          echo "Preparing Dexscreener Safari extension for unsigned export..."
          if [ ! -d "DexscreenerTraderExtension" ]; then
            echo "âš ï¸ DexscreenerTraderExtension folder not found, creating placeholder..."
            mkdir -p DexscreenerTraderExtension
            touch DexscreenerTraderExtension/placeholder.txt
            echo "âœ… Placeholder folder created."
          else
            echo "âœ… DexscreenerTraderExtension folder found."
          fi
      - name: ğŸ§¹ Build Xcode project (clean)
        script: |
          echo "ğŸ§¹ Cleaning Xcode project..."
          xcodebuild clean -project Dexscreener.xcodeproj -scheme "$APP_NAME"
      - name: ğŸ“¦ Archive Xcode build
        script: |
          echo "ğŸ“¦ Archiving Xcode project..."
          xcodebuild archive -project Dexscreener.xcodeproj \
          -scheme "$APP_NAME" \
          -archivePath "$PWD/build/$APP_NAME.xcarchive" \
          -destination "generic/platform=iOS"
      - name: ğŸ”‘ Create unsigned IPA for AltStore
        script: |
          echo "ğŸ”‘ Exporting unsigned IPA..."
          xcodebuild -exportArchive \
          -archivePath "$PWD/build/$APP_NAME.xcarchive" \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath "$PWD/build"
      - name: ğŸ—œï¸ Compress and rename IPA
        script: |
          echo "ğŸ—œï¸ Compressing IPA..."
          cd build
          zip -r "${APP_NAME}_unsigned.ipa.zip" "${APP_NAME}.ipa"
    artifacts:
      - build/${APP_NAME}_unsigned.ipa.zip
    publishing:
      scripts:
        - name: ğŸŒ Generate shareable artifact link
          script: |
            echo "Artifact ready for manual upload or AltStore sideload."
