workflows:
  safari_extension_convert:
    name: Safari Extension Auto-Build
    max_build_duration: 30
    instance_type: mac_mini_m2
    environment:
      xcode: 16.4
      vars:
        EXTENSION_NAME: "DexscreenerTraderExtension"
    scripts:
      - name: üßπ Clean workspace
        script: |
          rm -rf safari_project
          mkdir safari_project

      - name: üß© Verify and convert Chrome extension
        script: |
          echo "üîç Searching for manifest.json..."
          MANIFEST_PATH=$(find . -name manifest.json | head -n 1)
          if [ -z "$MANIFEST_PATH" ]; then
            echo "‚ùå No manifest.json found ‚Äî cannot continue."
            exit 1
          fi

          echo "‚úÖ Found manifest at: $MANIFEST_PATH"
          EXT_DIR=$(dirname "$MANIFEST_PATH")
          echo "Converting extension in: $EXT_DIR"

          cd "$EXT_DIR"
          xcrun safari-web-extension-converter . \
            --project-location "$PWD/../safari_project" \
            --app-name "${EXTENSION_NAME}" \
            --no-prompt \
            --force

          echo "‚úÖ Conversion complete. Checking output..."
          ls -la ../safari_project || echo "‚ö†Ô∏è safari_project folder is empty!"

      - name: üöÄ Build Safari extension app
        script: |
          echo "üì¶ Building Safari extension..."
          cd ../safari_project || { echo "‚ùå safari_project missing"; exit 1; }

          echo "Listing contents:"
          ls -R

          PROJECT=$(find . -name "*.xcodeproj" | head -n 1)
          if [ -z "$PROJECT" ]; then
            echo "‚ùå No Xcode project found after conversion."
            exit 1
          fi

          echo "‚úÖ Found project: $PROJECT"

          SCHEME=$(xcodebuild -list -project "$PROJECT" | grep -A1 "Schemes:" | tail -n1 | xargs)
          echo "Detected scheme: $SCHEME"

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found in project."
            exit 1
          fi

          xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration Release CODE_SIGNING_ALLOWED=NO

    artifacts:
      - safari_project/build/Release/
    publishing:
      email:
        recipients:
          - tradezconsulting@icloud.com
